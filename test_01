--// RedDrawUI.lua
--// Minimal Rayfield-style Drawing UI (executor-safe)

local UIS = game:GetService("UserInputService")
local RS  = game:GetService("RunService")

local UI = {}

UI.Theme = {
    Accent = Color3.fromRGB(220, 60, 60),
    Background = Color3.fromRGB(18, 18, 18),
    Panel = Color3.fromRGB(32, 32, 32),
    Text = Color3.fromRGB(240, 240, 240),
    Muted = Color3.fromRGB(150, 150, 150)
}

local function draw(class, props)
    local o = Drawing.new(class)
    for k,v in pairs(props or {}) do
        o[k] = v
    end
    return o
end

-- Compatibility no-ops
function UI:ApplyTheme(_) end
function UI:LoadConfiguration() end

--// WINDOW
function UI:CreateWindow(opts)
    local window = {}
    local tabs = {}
    local activeTab

    local pos = Vector2.new(300, 200)
    local size = Vector2.new(480, 360)
    local dragging, dragOffset

    local bg = draw("Square", {
        Size = size,
        Position = pos,
        Filled = true,
        Color = UI.Theme.Background
    })

    local header = draw("Square", {
        Size = Vector2.new(size.X, 42),
        Position = pos,
        Filled = true,
        Color = UI.Theme.Panel
    })

    local title = draw("Text", {
        Text = opts.Name or "UI",
        Size = 16,
        Color = UI.Theme.Text,
        Outline = true,
        Position = pos + Vector2.new(12, 11)
    })

    -- Dragging
    UIS.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 then
            local m = UIS:GetMouseLocation()
            if m.X >= pos.X and m.X <= pos.X + size.X
            and m.Y >= pos.Y and m.Y <= pos.Y + 42 then
                dragging = true
                dragOffset = m - pos
            end
        end
    end)

    UIS.InputEnded:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)

    RS.RenderStepped:Connect(function()
        if dragging then
            pos = UIS:GetMouseLocation() - dragOffset
            bg.Position = pos
            header.Position = pos
            title.Position = pos + Vector2.new(12, 11)
            for _,t in ipairs(tabs) do
                t:_reposition(pos)
            end
        end
    end)

    --// TAB
    function window:CreateTab(name, icon) -- icon accepted, ignored
        local tab = {}
        local elements = {}
        local visible = false

        local tabText = draw("Text", {
            Text = name,
            Size = 14,
            Color = UI.Theme.Muted,
            Outline = true
        })

        function tab:_reposition(base)
            tabText.Position = base + Vector2.new(14 + (#tabs * 100), 52)
            local y = base.Y + 84
            for _,e in ipairs(elements) do
                e:_move(base.X + 14, y)
                y += 32
            end
        end

        function tab:_set(state)
            visible = state
            tabText.Color = state and UI.Theme.Accent or UI.Theme.Muted
            for _,e in ipairs(elements) do
                e:_visible(state)
            end
        end

        UIS.InputBegan:Connect(function(i)
            if i.UserInputType == Enum.UserInputType.MouseButton1 then
                local m = UIS:GetMouseLocation()
                local p = tabText.Position
                if m.X >= p.X and m.X <= p.X + tabText.TextBounds.X
                and m.Y >= p.Y and m.Y <= p.Y + 18 then
                    if activeTab then activeTab:_set(false) end
                    activeTab = tab
                    tab:_set(true)
                end
            end
        end)

        -- TOGGLE
        function tab:CreateToggle(cfg)
            local t = {}
            local value = cfg.CurrentValue

            local label = draw("Text", {
                Text = cfg.Name,
                Size = 14,
                Color = UI.Theme.Text,
                Outline = true
            })

            local box = draw("Square", {
                Size = Vector2.new(16,16),
                Filled = true
            })

            local function refresh()
                box.Color = value and UI.Theme.Accent or UI.Theme.Panel
            end

            function t:_move(x,y)
                label.Position = Vector2.new(x,y)
                box.Position = Vector2.new(x+260,y+2)
                refresh()
            end

            function t:_visible(v)
                label.Visible = v
                box.Visible = v
            end

            UIS.InputBegan:Connect(function(i)
                if visible and i.UserInputType == Enum.UserInputType.MouseButton1 then
                    local m = UIS:GetMouseLocation()
                    if m.X >= box.Position.X and m.X <= box.Position.X+16
                    and m.Y >= box.Position.Y and m.Y <= box.Position.Y+16 then
                        value = not value
                        refresh()
                        cfg.Callback(value)
                    end
                end
            end)

            table.insert(elements, t)
        end

        -- SLIDER
        function tab:CreateSlider(cfg)
            local s = {}
            local min,max = cfg.Range[1], cfg.Range[2]
            local value = cfg.CurrentValue

            local label = draw("Text", {
                Text = cfg.Name .. ": " .. value,
                Size = 14,
                Color = UI.Theme.Text,
                Outline = true
            })

            local bar = draw("Square", {
                Size = Vector2.new(200,6),
                Filled = true,
                Color = UI.Theme.Panel
            })

            function s:_move(x,y)
                label.Position = Vector2.new(x,y)
                bar.Position = Vector2.new(x,y+18)
            end

            function s:_visible(v)
                label.Visible = v
                bar.Visible = v
            end

            UIS.InputBegan:Connect(function(i)
                if visible and i.UserInputType == Enum.UserInputType.MouseButton1 then
                    local m = UIS:GetMouseLocation()
                    local p = bar.Position
                    if m.X >= p.X and m.X <= p.X+bar.Size.X
                    and m.Y >= p.Y and m.Y <= p.Y+bar.Size.Y then
                        local pct = (m.X - p.X)/bar.Size.X
                        value = math.floor(min + (max-min)*pct)
                        label.Text = cfg.Name .. ": " .. value
                        cfg.Callback(value)
                    end
                end
            end)

            table.insert(elements, s)
        end

        -- DROPDOWN (click-to-cycle)
        function tab:CreateDropdown(cfg)
            local d = {}
            local index = table.find(cfg.Options, cfg.CurrentOption[1]) or 1

            local label = draw("Text", {
                Text = cfg.Name .. ": " .. cfg.Options[index],
                Size = 14,
                Color = UI.Theme.Text,
                Outline = true
            })

            function d:_move(x,y)
                label.Position = Vector2.new(x,y)
            end

            function d:_visible(v)
                label.Visible = v
            end

            UIS.InputBegan:Connect(function(i)
                if visible and i.UserInputType == Enum.UserInputType.MouseButton1 then
                    local m = UIS:GetMouseLocation()
                    local p = label.Position
                    if m.X >= p.X and m.X <= p.X+label.TextBounds.X
                    and m.Y >= p.Y and m.Y <= p.Y+18 then
                        index = index % #cfg.Options + 1
                        label.Text = cfg.Name .. ": " .. cfg.Options[index]
                        cfg.Callback(cfg.Options[index])
                    end
                end
            end)

            table.insert(elements, d)
            return { Refresh=function() end, Set=function() end }
        end

        -- COLOR PICKER (simple)
        function tab:CreateColorPicker(cfg)
            local c = {}

            local label = draw("Text", {
                Text = cfg.Name,
                Size = 14,
                Color = cfg.Color,
                Outline = true
            })

            function c:_move(x,y)
                label.Position = Vector2.new(x,y)
            end

            function c:_visible(v)
                label.Visible = v
            end

            table.insert(elements, c)
        end

        table.insert(tabs, tab)
        if not activeTab then
            activeTab = tab
            tab:_set(true)
        end

        return tab
    end

    return window
end

return UI
