--[[========================================
    REDFIELD UI (Drawing API)
    Minimal Rayfield-Compatible Test Library
==========================================]]

local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local GuiService = game:GetService("GuiService")

local inset = GuiService:GetGuiInset()

local function mousePos()
    local m = UIS:GetMouseLocation()
    return Vector2.new(m.X, m.Y - inset.Y)
end

local function inside(p, pos, size)
    return p.X >= pos.X and p.X <= pos.X + size.X
       and p.Y >= pos.Y and p.Y <= pos.Y + size.Y
end

local UI = {}
UI.__index = UI

-- theme
local COLORS = {
    bg = Color3.fromRGB(20, 20, 20),
    panel = Color3.fromRGB(30, 30, 30),
    red = Color3.fromRGB(200, 60, 60),
    text = Color3.new(1,1,1),
    dim = Color3.fromRGB(160,160,160)
}

local function newText(size)
    local t = Drawing.new("Text")
    t.Size = size
    t.Color = COLORS.text
    t.Outline = true
    t.Visible = false
    return t
end

local function newBox()
    local s = Drawing.new("Square")
    s.Filled = true
    s.Visible = false
    return s
end

--------------------------------------------------
-- WINDOW
--------------------------------------------------

function UI:CreateWindow(cfg)
    local win = setmetatable({}, UI)

    win.pos = Vector2.new(300, 200)
    win.size = Vector2.new(520, 420)
    win.drag = false
    win.dragOff = Vector2.zero

    win.tabs = {}
    win.activeTab = nil

    -- background
    win.bg = newBox()
    win.bg.Color = COLORS.bg

    win.top = newBox()
    win.top.Color = COLORS.red

    win.title = newText(18)
    win.title.Text = cfg.Name or "Window"

    --------------------------------------------------

    function win:_layout()
        self.bg.Position = self.pos
        self.bg.Size = self.size
        self.bg.Visible = true

        self.top.Position = self.pos
        self.top.Size = Vector2.new(self.size.X, 30)
        self.top.Visible = true

        self.title.Position = self.pos + Vector2.new(10, 6)
        self.title.Visible = true

        local tx = self.pos.X + 10
        local ty = self.pos.Y + 40

        for _,tab in ipairs(self.tabs) do
            tab:_layout(Vector2.new(tx, ty))
            ty += 26
        end

        if self.activeTab then
            self.activeTab:_layoutContent(
                self.pos + Vector2.new(120, 40),
                Vector2.new(self.size.X - 130, self.size.Y - 50)
            )
        end
    end

    --------------------------------------------------
    -- DRAGGING
    --------------------------------------------------

    UIS.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 then
            local m = mousePos()
            if inside(m, win.pos, Vector2.new(win.size.X, 30)) then
                win.drag = true
                win.dragOff = m - win.pos
            end
        end
    end)

    UIS.InputEnded:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 then
            win.drag = false
        end
    end)

    RunService.RenderStepped:Connect(function()
        if win.drag then
            win.pos = mousePos() - win.dragOff
        end
        win:_layout()
    end)

    --------------------------------------------------

    function win:CreateTab(name, icon)
        local tab = {}
        tab.name = name
        tab.icon = icon -- accepted, ignored
        tab.elements = {}

        tab.btn = newBox()
        tab.btn.Color = COLORS.panel

        tab.txt = newText(16)
        tab.txt.Text = name

        function tab:_layout(pos)
            self.btn.Position = pos
            self.btn.Size = Vector2.new(100, 24)
            self.btn.Visible = true

            self.txt.Position = pos + Vector2.new(8, 4)
            self.txt.Visible = true
        end

        function tab:_layoutContent(pos, size)
            local y = pos.Y
            for _,el in ipairs(self.elements) do
                el:_layout(Vector2.new(pos.X, y))
                y += el.height + 8
            end
        end

        UIS.InputBegan:Connect(function(i)
            if i.UserInputType == Enum.UserInputType.MouseButton1 then
                if inside(mousePos(), tab.btn.Position, tab.btn.Size) then
                    win.activeTab = tab
                end
            end
        end)

        --------------------------------------------------
        -- ELEMENTS
        --------------------------------------------------

        function tab:CreateToggle(cfg)
            local t = {}
            t.height = 26
            t.state = cfg.CurrentValue or false

            t.box = newBox()
            t.box.Color = COLORS.panel

            t.txt = newText(15)
            t.txt.Text = cfg.Name

            t.ind = newBox()
            t.ind.Color = COLORS.red

            function t:_layout(pos)
                self.box.Position = pos
                self.box.Size = Vector2.new(240, 24)
                self.box.Visible = true

                self.txt.Position = pos + Vector2.new(8, 4)
                self.txt.Visible = true

                self.ind.Position = pos + Vector2.new(220, 4)
                self.ind.Size = Vector2.new(16, 16)
                self.ind.Visible = self.state
            end

            UIS.InputBegan:Connect(function(i)
                if i.UserInputType == Enum.UserInputType.MouseButton1 then
                    if inside(mousePos(), t.box.Position, t.box.Size) then
                        t.state = not t.state
                        t.ind.Visible = t.state
                        cfg.Callback(t.state)
                    end
                end
            end)

            table.insert(tab.elements, t)
        end

        function tab:CreateSlider(cfg)
            local s = {}
            s.height = 36
            s.val = cfg.CurrentValue or cfg.Range[1]

            s.box = newBox()
            s.box.Color = COLORS.panel

            s.fill = newBox()
            s.fill.Color = COLORS.red

            s.txt = newText(15)

            function s:_layout(pos)
                self.box.Position = pos
                self.box.Size = Vector2.new(240, 10)
                self.box.Visible = true

                local pct = (self.val - cfg.Range[1]) / (cfg.Range[2] - cfg.Range[1])
                self.fill.Position = pos
                self.fill.Size = Vector2.new(240 * pct, 10)
                self.fill.Visible = true

                self.txt.Text = cfg.Name .. ": " .. math.floor(self.val)
                self.txt.Position = pos + Vector2.new(0, -16)
                self.txt.Visible = true
            end

            UIS.InputBegan:Connect(function(i)
                if i.UserInputType == Enum.UserInputType.MouseButton1 then
                    local m = mousePos()
                    if inside(m, s.box.Position, s.box.Size) then
                        local pct = math.clamp((m.X - s.box.Position.X) / 240, 0, 1)
                        s.val = cfg.Range[1] + pct * (cfg.Range[2] - cfg.Range[1])
                        cfg.Callback(s.val)
                    end
                end
            end)

            table.insert(tab.elements, s)
        end

        function tab:CreateDropdown(cfg)
            local d = {}
            d.height = 26
            d.sel = cfg.CurrentOption[1]

            d.box = newBox()
            d.box.Color = COLORS.panel

            d.txt = newText(15)

            function d:_layout(pos)
                self.box.Position = pos
                self.box.Size = Vector2.new(240, 24)
                self.box.Visible = true

                self.txt.Text = cfg.Name .. ": " .. tostring(d.sel)
                self.txt.Position = pos + Vector2.new(8, 4)
                self.txt.Visible = true
            end

            UIS.InputBegan:Connect(function(i)
                if i.UserInputType == Enum.UserInputType.MouseButton1 then
                    if inside(mousePos(), d.box.Position, d.box.Size) then
                        d.sel = cfg.Options[1]
                        cfg.Callback(d.sel)
                    end
                end
            end)

            table.insert(tab.elements, d)
        end

        table.insert(win.tabs, tab)
        if not win.activeTab then
            win.activeTab = tab
        end

        return tab
    end

    return win
end

return UI
